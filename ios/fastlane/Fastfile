default_platform(:ios)

platform :ios do
  desc "Build iOS development IPA"
  lane :build_dev do
    # Setup signing using App Store Connect API
    setup_ci if ENV['CI']

    # Get App Store Connect API Key from environment variables
    api_key = app_store_connect_api_key(
      key_id: ENV['APP_STORE_CONNECT_KEY_ID'],
      issuer_id: ENV['APP_STORE_CONNECT_ISSUER_ID'],
      key_content: ENV['APP_STORE_CONNECT_KEY_CONTENT'],
      is_key_content_base64: true
    )

    # Sync certificates and provisioning profiles
    # Note: This requires a certificates repository to be set up
    # Alternative: Use automatic signing with match or manual certificate setup

    # For development build without match, use automatic signing
    update_code_signing_settings(
      use_automatic_signing: true,
      path: "Runner.xcodeproj",
      team_id: ENV['APPLE_TEAM_ID'],
      bundle_identifier: "com.example.yomiagerunApp"
    )

    # Build the app
    build_app(
      workspace: "Runner.xcworkspace",
      scheme: "Runner",
      export_method: "development",
      output_directory: "./build",
      output_name: "yomiagerun_app.ipa",
      xcargs: "-allowProvisioningUpdates -authenticationKeyPath ~/private_keys/AuthKey_#{ENV['APP_STORE_CONNECT_KEY_ID']}.p8 -authenticationKeyID #{ENV['APP_STORE_CONNECT_KEY_ID']} -authenticationKeyIssuerID #{ENV['APP_STORE_CONNECT_ISSUER_ID']}"
    )
  end

  desc "Build iOS App Store IPA"
  lane :build_release do
    setup_ci if ENV['CI']

    api_key = app_store_connect_api_key(
      key_id: ENV['APP_STORE_CONNECT_KEY_ID'],
      issuer_id: ENV['APP_STORE_CONNECT_ISSUER_ID'],
      key_content: ENV['APP_STORE_CONNECT_KEY_CONTENT'],
      is_key_content_base64: true
    )

    update_code_signing_settings(
      use_automatic_signing: true,
      path: "Runner.xcodeproj",
      team_id: ENV['APPLE_TEAM_ID'],
      bundle_identifier: "com.example.yomiagerunApp"
    )

    build_app(
      workspace: "Runner.xcworkspace",
      scheme: "Runner",
      export_method: "app-store",
      output_directory: "./build",
      output_name: "yomiagerun_app.ipa",
      xcargs: "-allowProvisioningUpdates -authenticationKeyPath ~/private_keys/AuthKey_#{ENV['APP_STORE_CONNECT_KEY_ID']}.p8 -authenticationKeyID #{ENV['APP_STORE_CONNECT_KEY_ID']} -authenticationKeyIssuerID #{ENV['APP_STORE_CONNECT_ISSUER_ID']}"
    )
  end

  desc "Upload IPA to TestFlight"
  lane :upload_testflight do
    setup_ci if ENV['CI']

    # Setup App Store Connect API Key
    api_key = app_store_connect_api_key(
      key_id: ENV['APP_STORE_CONNECT_KEY_ID'],
      issuer_id: ENV['APP_STORE_CONNECT_ISSUER_ID'],
      key_content: ENV['APP_STORE_CONNECT_KEY_CONTENT'],
      is_key_content_base64: true
    )

    # Build App Store IPA
    build_release

    # Upload to TestFlight
    upload_to_testflight(
      api_key: api_key,
      skip_waiting_for_build_processing: true,
      skip_submission: true,
      distribute_external: false,
      ipa: "./build/yomiagerun_app.ipa"
    )

    UI.success("âœ… Successfully uploaded to TestFlight!")
    UI.message("ðŸ”— Check your build status at: https://appstoreconnect.apple.com/")
  end
end
