# Issue再編成サマリー（Issue-09以降）

**作成日**: 2025-12-27
**対象**: Issue #9, #10, #11
**理由**: WebViewベースのサイトUI拡張アプローチへの移行

---

## 1. 変更の背景

### 問題の発見
Issue-08完了後、実装されたアプリが以下のような「テキストビューア」になっていることが判明：

```
┌────────────────────┐
│ URL入力フィールド   │
│ [読み込みボタン]    │
├────────────────────┤
│                    │
│  テキスト表示      │
│  （本文のみ）      │
│                    │
├────────────────────┤
│  速度設定          │
├────────────────────┤
│  再生コントロール   │
└────────────────────┘
```

### ユーザーの意図
しかし、ユーザーが求めていたのは**「サイトUI拡張」**のアプローチ：

```
┌────────────────────┐
│                    │
│  WebView           │
│  (syosetu.com      │
│   そのまま表示)    │
│                    │
├────────────────────┤
│  速度設定          │
├────────────────────┤
│  再生コントロール   │
└────────────────────┘
```

**アプリのコンセプト**:
- ブラウザ拡張機能のようなもの
- ユーザーはサイト内を自然にブラウジング
- 小説ページでTTS機能が有効化
- URL入力は不要

---

## 2. 旧Issue計画（変更前）

### Issue #9: 読み上げ位置のハイライト表示機能
- TtsService に読み上げ位置コールバックを追加
- NovelContentView でハイライト表示を実装
- RichText + TextSpan を使用

### Issue #10: 読み上げ位置の自動スクロール機能
- NovelContentView に ScrollController を追加
- 読み上げ位置の変更を監視
- スムーズなスクロールアニメーション

### Issue #11: MVPの総合テストと最終調整
- 統合テストシナリオの作成（URL入力 → 読み込み → 再生）
- 実機でのテスト
- UI/UX調整

**問題点**:
- URL入力からのテキスト表示を前提とした設計
- ユーザーが求める「サイト内ブラウジング」体験が提供できない

---

## 3. 新Issue計画（変更後）

### Issue #9: WebViewブラウザ実装とUI統合 ⚠️ **NEW**

**優先度**: 最高
**見積もり**: 3時間
**依存**: Issue #6, #7, #8

#### 主な変更点
- URL入力UIを削除し、全画面WebViewに置き換え
- 初期表示: `https://syosetu.com/`（暫定）
- 下部にTTSコントロール（速度設定 + 再生コントローラー）を配置
- WebView内でのナビゲーション機能
- `WebViewState` と `WebViewNotifier` の作成

#### 既存コードの扱い
- **削除しない**: `NovelReaderNotifier`, `NovelContentView` は将来削除するが、今は使用停止のみ
- **コメントアウト**: URL入力関連のUIコード
- **段階移行**: Issue #10でページ検出を追加してから、TTS機能を統合

---

### Issue #10: 小説ページ検出とTTS統合 ⚠️ **NEW**

**優先度**: 最高
**見積もり**: 3.5時間
**依存**: Issue #5, #9

#### 主な変更点
- WebView内のURL変化を監視
- 小説ページのURLパターンを検出
  - 小説本文: `https://ncode.syosetu.com/nXXXX/Y/`
  - 短編: `https://ncode.syosetu.com/nXXXX/`
- 小説ページで自動的に本文を抽出（`NarouParserService` を再利用）
- TTSコントロールの有効/無効を自動切り替え
- 既存の `TtsService` と統合

#### 新規作成
- `NarouUrlDetector`: URL判定ユーティリティ
- ページ検出と TTS制御のフロー

---

### Issue #11: WebViewブラウザ統合テストとUX改善 ⚠️ **UPDATED**

**優先度**: 高
**見積もり**: 4時間
**依存**: すべての前Issue

#### 主な変更点
- **ハイライト機能を統合**: JavaScript Injection で DOM を直接操作
  - 現在読み上げ中の段落に CSS class を追加
  - `element.scrollIntoView()` で自動スクロール
  - TtsService に進捗コールバックを追加
- **統合テストシナリオを更新**:
  1. アプリ起動 → トップページ表示
  2. サイト内を自然にブラウジング
  3. 小説ページへ遷移
  4. TTSコントロールが自動的に有効化
  5. 再生 → ハイライト → 自動スクロール確認
  6. 非小説ページへ遷移時の動作確認
- **コードクリーンアップ**: 未使用コード（`NovelContentView`など）の削除

#### 統合される機能
- 元々Issue #9で予定していたハイライト機能
- 元々Issue #10で予定していた自動スクロール機能

---

## 4. Issue間の依存関係の変化

### 旧依存関係
```
Issue #8 (本文表示UI)
    └─→ Issue #9 (ハイライト) ← Issue #5
            └─→ Issue #10 (自動スクロール)
                    └─→ Issue #11 (総合テスト)
```

### 新依存関係
```
Issue #6 + #7 + #8
    └─→ Issue #9 (WebViewブラウザ実装)
            └─→ Issue #10 (ページ検出とTTS統合) ← Issue #5
                    └─→ Issue #11 (統合テスト + ハイライト + 自動スクロール)
```

---

## 5. 実装方針の変更点まとめ

| 項目 | 旧方針 | 新方針 |
|------|--------|--------|
| **UI** | URL入力 + テキスト表示 | WebViewブラウザ |
| **初期表示** | 空白画面 + URL入力 | syosetu.com トップページ |
| **ナビゲーション** | URL入力のみ | WebView内で自然にブラウジング |
| **本文表示** | NovelContentView | WebView内でサイトをそのまま表示 |
| **TTS有効化** | 手動（読み込みボタン） | 自動（小説ページ検出） |
| **ハイライト** | RichText + TextSpan | JavaScript Injection + DOM操作 |
| **スクロール** | ScrollController | JavaScript Injection + scrollIntoView |

---

## 6. 段階移行戦略

### 既存コードの扱い
- **削除しない**: 削除工数が無駄なため、使用を停止するのみ
- **保持するコード**:
  - `NovelReaderNotifier.loadNovel()`
  - `NovelContentView` ウィジェット
  - URL入力関連のUI
- **今後の方針**: Issue #11のコードクリーンアップで削除

### テストの扱い
- **既存テスト**: 必要に応じてスキップマーク（`skip: true`）を使用
- **新規テスト**: WebViewブラウザとページ検出の新規テストを追加

---

## 7. 技術的な実装の変化

### ハイライト表示

#### 旧方式（RichText + TextSpan）
```dart
RichText(
  text: TextSpan(
    children: paragraphs.map((p, index) {
      return TextSpan(
        text: p,
        style: index == currentPosition
          ? highlightStyle
          : normalStyle,
      );
    }).toList(),
  ),
)
```

#### 新方式（JavaScript Injection）
```dart
await _controller.runJavaScript('''
  const paragraphs = document.querySelectorAll('#novel_honbun p');
  if (paragraphs[$index]) {
    paragraphs[$index].classList.add('tts-highlight');
    paragraphs[$index].scrollIntoView({
      behavior: 'smooth',
      block: 'center'
    });
  }
''');
```

**新方式の利点**:
- サイトの表示をそのまま保持
- スクロールも同時に実装可能
- サイトのデザインに自然に統合

---

## 8. 見積もりの変化

| フェーズ | 旧見積もり | 新見積もり | 差分 |
|---------|-----------|-----------|------|
| Phase 3 | 7時間 | 9時間 | +2時間 |
| Phase 4 | 3時間 | 4時間 | +1時間 |
| **合計** | **22.5時間** | **25.5時間** | **+3時間** |

**増加理由**:
- WebViewブラウザの実装（新規）
- ページ検出機能の実装（新規）
- JavaScript Injection の実装（新規）

---

## 9. MVP要件への影響

### 変更なし（引き続き満たす）
- ✅ 小説閲覧機能
- ✅ 読み上げ機能
- ✅ 読み上げ速度設定
- ✅ 再生コントローラー
- ✅ ハイライト表示
- ✅ 自動スクロール

### 改善される点
- ✅ **より自然な閲覧体験**: サイト内を自由にブラウジング
- ✅ **自動化**: 小説ページを自動検出してTTS有効化
- ✅ **サイトデザインの保持**: テキストのみではなく、サイトをそのまま表示

---

## 10. 次のステップ

### Issue-09の開始
1. `documents/issues/issue-09.md` を確認
2. 実施計画を Issue にコメント
3. ブランチ作成: `feature/issue-09-webview-browser`
4. WebViewブラウザの実装開始

### 実装の流れ
1. **Issue-09**: WebViewブラウザの基本実装（3時間）
2. **Issue-10**: ページ検出とTTS統合（3.5時間）
3. **Issue-11**: 統合テスト + ハイライト + 自動スクロール（4時間）

**合計**: 10.5時間でMVP完成

---

## 11. まとめ

### 変更の本質
- **テキストビューア** → **WebViewベースのブラウザ**
- **手動URL入力** → **自然なブラウジング**
- **本文のみ表示** → **サイト全体を表示**
- **手動有効化** → **自動検出・自動有効化**

### ユーザー体験の変化
```
【旧】
1. URLをコピー
2. アプリに貼り付け
3. 読み込みボタンタップ
4. テキストのみ表示
5. 再生ボタンタップ

【新】
1. アプリ起動（サイトトップ表示）
2. サイト内を普通にブラウジング
3. 小説ページに到達
4. 自動的にTTS有効化
5. 再生ボタンタップ
```

### Issue-08までの実装
- **削除しない**: 将来的に整理するが、今は保持
- **学習価値**: 実装を通じて、アーキテクチャとテストの書き方を習得
- **再利用可能**: `NarouParserService` などは新方式でも再利用

---

**承認**: 段階移行アプローチにより、既存の実装を活かしつつ、新しいUXを実現
**次のアクション**: Issue-09の実施計画を作成し、WebViewブラウザ実装を開始
