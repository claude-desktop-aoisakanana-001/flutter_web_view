# 小説家になろう HTML構造解析レポート

**プロジェクト名**: 小説家になろうリーダーアプリ
**作成日**: 2025-11-30
**バージョン**: 1.0.0
**ステータス**: 調査完了

---

## ⚠️ 重要な注意事項

### 利用規約による制限

調査の結果、**小説家になろうの利用規約では、コンテンツのスクレイピングは一切認められていない**ことが判明しました。

**制限事項**:
- 小説本文の直接スクレイピングは規約違反
- 自動的なHTTP GETによるコンテンツ取得は禁止
- なろう小説APIはメタデータ（タイトル、あらすじ、評価など）のみ取得可能

**参考資料**:
- [Pythonによるスクレイピングで『小説家になろう』から小説本文を取得する](https://scol.hatenablog.com/entry/2019/04/04/193000)
- [Web小説の分析をしたいと思ったら読んでもらいたい話](https://qiita.com/okada1220/items/c2ffc32acb255d609312)

### 推奨される代替アプローチ

本アプリケーションの実装では、以下のいずれかのアプローチを採用する必要があります：

#### オプション A: WebView内表示（推奨）
- **方法**: `webview_flutter` を使用してブラウザ内で小説を表示
- **メリット**:
  - 利用規約に準拠
  - ユーザーが公式サイトを通じて閲覧
  - JavaScript実行やログイン状態の保持が可能
- **デメリット**:
  - HTML解析が複雑（JavaScript実行後のDOM取得が必要）
  - メモリ消費が大きい

#### オプション B: ユーザーによる手動コピー＆ペースト
- **方法**: ユーザーが小説本文をコピーしてアプリに貼り付け
- **メリット**:
  - 利用規約に準拠
  - シンプルな実装
- **デメリット**:
  - ユーザビリティが低い

#### オプション C: 代替データソースの使用
- **方法**: 青空文庫など、スクレイピングが許可されているサイトを対象とする
- **メリット**:
  - 合法的なデータ取得
  - 著作権フリーのコンテンツ
- **デメリット**:
  - 対象作品が限定的

---

## 技術的なHTML構造解析結果

以下の情報は、技術的な調査結果として記録します。**実装時には利用規約を遵守する必要があります。**

### 1. 基本的なHTML構造

#### 1.1 全体構造

```html
<div id="container">
  <div id="contents">
    <div id="novel_header">
      <!-- ヘッダー情報 -->
    </div>
    <div id="novel_contents">
      <!-- 小説本文コンテナ -->
      <div id="novel_honbun">
        <!-- 本文 -->
      </div>
    </div>
  </div>
</div>
```

#### 1.2 主要なセレクタ一覧

| 要素 | CSSセレクタ | 説明 |
|------|------------|------|
| 小説タイトル | `.novel_title` | 作品のタイトル |
| 章タイトル | `.novel_subtitle` | エピソードや章のタイトル |
| 作者名 | `.novel_writername` | 作者の名前 |
| 本文コンテナ | `#novel_honbun` | 小説本文全体を含むコンテナ |
| 本文段落 | `#novel_honbun p` | 各段落のテキスト |
| 前書き | `#novel_p` | 前書き部分 |
| 後書き | `#novel_a` | 後書き部分 |

**参考資料**:
- [Pythonによるスクレイピングで『小説家になろう』から小説本文を取得する](https://scol.hatenablog.com/entry/2019/04/04/193000)
- [「小説家になろう」の追っかけ読書ツールを作った話](https://zenn.dev/qnighy/articles/16f4040e6e8768)

---

### 2. ルビ（振り仮名）の処理

#### 2.1 なろう記法

小説家になろうでは、以下の記法でルビを指定します：

```
｜漢字《かんじ》
漢字（かんじ）
```

**ルール**:
- `｜` でベーステキストの開始を明示
- `《》` または `()` でルビテキストを囲む
- ベーステキストが漢字でルビがひらがな/カタカナの場合、`｜` は省略可能
- ベーステキスト: 1〜10文字（`｜` 使用時は20文字まで）
- ルビテキスト: 最大10文字

#### 2.2 HTML出力形式

なろう記法は、HTML5の `<ruby>` タグに変換されます：

```html
<ruby>
  漢字
  <rp>(</rp>
  <rt>かんじ</rt>
  <rp>)</rp>
</ruby>
```

**タグの説明**:
- `<ruby>`: ルビ全体のコンテナ
- `<rt>`: ルビテキスト（読み仮名）
- `<rp>`: フォールバック用の括弧（ルビ非対応ブラウザ向け）

#### 2.3 パース戦略

HTMLパーサー（`html` パッケージ）でルビを処理する際：

1. `<ruby>` 要素を検出
2. ベーステキストと `<rt>` 内のルビテキストを分離
3. TTS用には `<ruby>` の `innerText` を使用（ルビを含まない）
4. 表示用には `<ruby>` タグをそのまま保持

**サンプルコード**:
```dart
// ruby要素の処理例
final rubyElements = document.querySelectorAll('ruby');
for (var ruby in rubyElements) {
  final baseText = ruby.text; // "漢字"
  final rtElement = ruby.querySelector('rt');
  final rubyText = rtElement?.text; // "かんじ"

  // TTS用: ベーステキストのみ使用
  // 表示用: rubyタグごと保持
}
```

**参考資料**:
- [小説家になろうのルビの書き方・仕様の解説](https://whiteleaf.hatenablog.com/entry/2013/03/27/小説家になろうのルビの書き方・仕様の解説)
- [なろうルビ仕様](https://github.com/whiteleaf7/narou/wiki/なろうルビ仕様)
- [ルビの挿入 | ヘルプセンター | 小説家になろう](https://syosetu.com/helpcenter/helppage/helppageid/42)

---

### 3. 傍点（圏点）の処理

#### 3.1 傍点の記法

小説家になろうでは、傍点機能が提供されています。従来はルビ機能で代用していました：

**従来の方法（ルビで代用）**:
```
｜傍《・》｜点《・》
```

**現在の方法**:
小説家になろうには傍点挿入機能があり、HTML5の `<ruby>` タグで実装されています。

#### 3.2 HTML出力

```html
<ruby>対<rt>・</rt></ruby><ruby>象<rt>・</rt></ruby>
```

#### 3.3 パース戦略

- `<rt>` の内容が `・` などの記号のみの場合、傍点として扱う
- TTS読み上げ時は傍点を無視するか、強調として扱う
- 表示時はCSSで適切にスタイリング

**参考資料**:
- [傍点の挿入 | ヘルプセンター | 小説家になろう](https://syosetu.com/helpcenter/helppage/helppageid/43)
- [web小説の書き方、ルール文書規則と各なろう要素 - 10. ルビ、振り仮名、傍点](https://ncode.syosetu.com/n9885er/10/)

---

### 4. 改行と段落の処理

#### 4.1 段落の構造

本文は `<p>` タグで段落分けされています：

```html
<div id="novel_honbun">
  <p>第一段落のテキスト。</p>
  <p>第二段落のテキスト。</p>
  <p><br></p>  <!-- 空行 -->
  <p>第三段落のテキスト。</p>
</div>
```

#### 4.2 改行の種類

- **段落区切り**: `</p><p>` で表現
- **空行**: `<p><br></p>` または `<p></p>`
- **段落内改行**: `<br>` タグ

#### 4.3 パース戦略

```dart
// 段落の取得
final paragraphs = document.querySelectorAll('#novel_honbun p');

final List<String> textList = [];
for (var p in paragraphs) {
  final text = p.text.trim();

  if (text.isEmpty) {
    // 空行は改行文字として保持
    textList.add('\n');
  } else {
    textList.add(text);
  }
}
```

---

### 5. エッジケースと特殊記法

#### 5.1 ルビの連続使用

```html
<ruby>東京<rt>とうきょう</rt></ruby>の<ruby>空<rt>そら</rt></ruby>
```

**対処法**: 各 `<ruby>` 要素を個別に処理し、間のテキストも保持

#### 5.2 ネストされた要素

通常、ルビ内にさらにルビがネストされることはありませんが、稀に複雑な構造がある可能性があります。

**対処法**: 再帰的なパース処理を実装

#### 5.3 特殊文字のエスケープ

HTML特殊文字（`&lt;`, `&gt;`, `&amp;` など）は適切にエスケープされています。

**対処法**: `html` パッケージが自動的に処理

#### 5.4 空白文字の処理

全角スペースや複数のスペースが含まれる場合があります。

**対処法**:
- 表示用: そのまま保持
- TTS用: 正規化を検討

---

### 6. User-Agent の設定

小説家になろうからHTMLを取得する際（仮に許可された場合）、適切なUser-Agentヘッダーの設定が必要です：

```dart
final response = await http.get(
  Uri.parse(url),
  headers: {
    'User-Agent': 'YomiagerunApp/1.0.0 (Flutter; +https://example.com/bot)',
  },
);
```

**参考資料**:
- [Pythonスクレイピングを使って『小説家になろう』のランキングからテキストデータを取得するサンプルコード](https://karupoimou.hatenablog.com/entry/2019/04/28/064159)

---

### 7. レスポンシブデザイン

小説家になろうはPC版とモバイル版で異なるHTML構造を持ちます：

- **PC版**: 上記のセレクタが使用される
- **モバイル版**: 一部のクラス名やID名が異なる可能性

**対処法**:
- User-Agentに基づいて異なるHTMLが返される
- 両方のバージョンに対応するため、複数のセレクタを試行

**参考資料**:
- [小説家になろうの活動報告のHTML/CCまとめ](https://note.com/eveningmoon_lab/n/n21ed39e985c1)

---

## 8. 推奨パース実装戦略

### 8.1 段階的なアプローチ

#### Phase 1: 基本的な本文抽出（MVP）
- `#novel_honbun` から段落を取得
- `<p>` タグのテキストを抽出
- ルビは一旦無視（innerTextを使用）

#### Phase 2: ルビ対応
- `<ruby>` タグを検出
- ベーステキストとルビテキストを分離
- 表示用とTTS用で異なる処理

#### Phase 3: 傍点・特殊記法対応
- 傍点の検出と処理
- その他の特殊記法への対応

### 8.2 エラーハンドリング

想定されるエラー：
1. **セレクタが見つからない**: HTML構造が変更された
2. **予期しない要素**: 新しい記法や構造
3. **文字化け**: エンコーディングの問題

**対処法**:
- 複数のフォールバックセレクタを用意
- ログ記録と適切なエラーメッセージ
- UTF-8エンコーディングの明示的な指定

---

## 9. サンプルHTMLスニペット

### 9.1 標準的な小説ページ

```html
<div id="novel_contents">
  <p class="novel_subtitle">第一章 始まりの日</p>

  <div id="novel_p">
    <p>これは前書きです。</p>
  </div>

  <div id="novel_honbun">
    <p>
      <ruby>東京<rt>とうきょう</rt></ruby>の街を歩いていた。
    </p>
    <p>
      突然、空から何かが落ちてきた。
    </p>
    <p><br></p>
    <p>
      それは<ruby>不思議<rt>ふしぎ</rt></ruby>な<ruby>出来事<rt>できごと</rt></ruby>だった。
    </p>
  </div>

  <div id="novel_a">
    <p>これは後書きです。</p>
  </div>
</div>
```

### 9.2 傍点を含む例

```html
<div id="novel_honbun">
  <p>
    これは<ruby>重<rt>・</rt></ruby><ruby>要<rt>・</rt></ruby>な知らせだ。
  </p>
</div>
```

---

## 10. 実装時の推奨事項

### 10.1 ライブラリの選択

- **HTMLパース**: `html` パッケージ（Dart公式）
- **HTTP通信**: `http` パッケージ
- **WebView**: `webview_flutter`（オプションA採用時）

### 10.2 テストデータ

実装時のテストには、以下を使用：
- モックHTML（上記サンプルを基に作成）
- 青空文庫の作品（スクレイピング許可済み）
- ユーザーが手動で提供したテキスト

### 10.3 設定可能な項目

- ルビの表示/非表示
- TTS時のルビ読み上げ（ベーステキスト or ルビテキスト）
- 傍点の扱い（読み上げ時の強調など）

---

## 11. 今後の検討事項

### 11.1 アーキテクチャの再検討

**現状**: tech-selection.md では「HTTP直接取得（Option B）」が選択されている

**問題**: 利用規約によりスクレイピングが禁止されている

**推奨**:
1. WebView内表示（Option A）への変更を検討
2. または、代替データソース（青空文庫など）への対応

### 11.2 ユーザーへの通知

アプリ内で以下を明示する必要があります：
- 小説家になろうの利用規約を遵守する旨
- データ取得方法（WebView使用、手動入力など）
- 著作権に関する注意事項

### 11.3 なろう小説APIの活用

小説家になろうは公式APIを提供しています：
- **取得可能**: タイトル、あらすじ、ランキング、評価ポイントなど
- **取得不可**: 小説本文

**用途**:
- 小説検索機能
- ランキング表示
- メタデータの取得

**参考資料**:
- [なろう小説API というものを呼んでみる](https://zenn.dev/derwind/articles/dwd-narou-syosetu-api)

---

## 12. 変更履歴

| 日付 | バージョン | 変更内容 |
|------|----------|---------|
| 2025-11-30 | 1.0.0 | 初版作成。利用規約の制限を明記、技術的な解析結果をまとめ |

---

## 13. 結論

### 技術的には可能だが、法的には不可

小説家になろうのHTML構造は明確で、技術的にはパース可能です。しかし、**利用規約により小説本文のスクレイピングは禁止されています**。

### 次のステップ

1. **Issue #3 の実装方針を変更**:
   - WebView内表示への切り替え
   - または代替データソース（青空文庫）への対応

2. **tech-selection.md の更新**:
   - Option A（WebView）の再評価
   - 利用規約遵守の明記

3. **ステークホルダーとの協議**:
   - アプリの方向性の確認
   - 対象サイトの再検討

---

## 14. 参考資料まとめ

### HTML構造・スクレイピング
- [Pythonによるスクレイピングで『小説家になろう』から小説本文を取得する](https://scol.hatenablog.com/entry/2019/04/04/193000)
- [「小説家になろう」の追っかけ読書ツールを作った話](https://zenn.dev/qnighy/articles/16f4040e6e8768)
- [Web小説の分析をしたいと思ったら読んでもらいたい話](https://qiita.com/okada1220/items/c2ffc32acb255d609312)

### ルビ記法
- [小説家になろうのルビの書き方・仕様の解説](https://whiteleaf.hatenablog.com/entry/2013/03/27/小説家になろうのルビの書き方・仕様の解説)
- [なろうルビ仕様](https://github.com/whiteleaf7/narou/wiki/なろうルビ仕様)
- [ルビの挿入 | ヘルプセンター | 小説家になろう](https://syosetu.com/helpcenter/helppage/helppageid/42)
- [各種小説投稿サイトのルビ記法をJavaScriptで実現する](https://qiita.com/8amjp/items/d7c46d9dee0da4d530ef)

### 傍点記法
- [傍点の挿入 | ヘルプセンター | 小説家になろう](https://syosetu.com/helpcenter/helppage/helppageid/43)
- [web小説の書き方、ルール文書規則と各なろう要素 - 10. ルビ、振り仮名、傍点](https://ncode.syosetu.com/n9885er/10/)

### API
- [なろう小説API というものを呼んでみる](https://zenn.dev/derwind/articles/dwd-narou-syosetu-api)

### その他
- [小説家になろう用のユーザースタイル](http://note.clovana.net/?p=169)
- [小説家になろうの活動報告のHTML/CCまとめ](https://note.com/eveningmoon_lab/n/n21ed39e985c1)

---

**作成者**: Claude AI Assistant
**承認日**: 2025-11-30
